<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schild-WebUntis-Tool</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        .btn:hover {
            opacity: 0.8;
        }

        .email-body {
            margin-top: 10px;
        }

        #settingsPanel {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        #emailEditor {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        #shortcutCreator {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        #uploadArea {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .nav-tabs {
            margin-bottom: 15px;
        }

            .nav-tabs .nav-link {
                color: #555;
                background-color: #e9ecef;
                border: 1px solid #ddd;
                margin-right: 5px;
                border-radius: 5px 5px 0 0;
            }

                .nav-tabs .nav-link.active {
                    color: #000;
                    background-color: #fff;
                    border-bottom: 1px solid #fff;
                }

        #settingsContainer > div {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .logo-img {
            height: 8em; /* Adjust this value to match text size */
            width: auto; /* Keep aspect ratio */
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .ml-3 {
            margin-left: 1rem; /* Space between logo and text */
        }

        .mb-0 {
            margin-bottom: 0; /* Remove bottom margin for the title */
        }

        .d-flex button {
            height: 100%; /* Ensures buttons fill the height of the flexbox container */
            max-height: 40px; /* Sets a consistent max height for all buttons */
            display: inline-flex; /* Flex alignment within the button itself */
            align-items: center; /* Centers text/icon vertically */
            justify-content: center; /* Centers text/icon horizontally */
            padding: 0; /* Removes excess padding that might affect alignment */
            margin: 0; /* Normalizes spacing between buttons */
        }

        .d-flex .btn {
            line-height: 1.2; /* Ensures text and icons are balanced vertically */
        }

    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex align-items-center">
            <!-- Logo -->
            <img src="{{ url_for('static', filename='favicon.jpg') }}" alt="Logo" class="logo-img">

            <!-- Title -->
            <h1 class="ml-3 mb-0">Schild-WebUntis-Tool</h1>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                Hauptbereich (und Einstellungen f√ºr die aktuelle Ausf√ºhrung)
            </div>
            <div class="card-body">
                <form method="post">
                    <div class="row">
                        <!-- Spalte 1 (linke Seite): Abschlussdatum, 2te Datei, Klassengr√∂√üen -->
                        <div class="col-md-6">
                            <h5 class="mb-3">Verarbeitungseinstellungen</h5>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="use_abschlussdatum" name="use_abschlussdatum" {% if use_abschlussdatum %}checked{% endif %}>
                                <label class="form-check-label" for="use_abschlussdatum">
                                    üóìÔ∏è Benutze Vorrauss. Abschlussdatum als Entlassdatum
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="enable_attestpflicht_column" name="enable_attestpflicht_column" {% if enable_attestpflicht_column %}checked{% endif %}>
                                <label class="form-check-label" for="enable_attestpflicht_column">
                                    üìÑ Attestpflicht-Spalte hinzuf√ºgen
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="enable_nachteilsausgleich_column" name="enable_nachteilsausgleich_column" {% if enable_nachteilsausgleich_column %}checked{% endif %}>
                                <label class="form-check-label" for="enable_nachteilsausgleich_column">
                                    ‚ôø Nachteilsausgleich-Spalte hinzuf√ºgen
                                </label>
                            </div>
                            <h5 class="mb-3">Zus√§tzliche Exporte</h5>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="create_second_file" name="create_second_file" {% if create_second_file %}checked{% endif %}>
                                <label class="form-check-label" for="create_second_file">
                                    üîé Erstelle Liste mit fehlenden Entlassdatumsangaben
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="create_class_size_file" name="create_class_size_file" {% if create_class_size_file %}checked{% endif %}>
                                <label class="form-check-label" for="create_class_size_file">
                                    üìä Erstelle Klassengr√∂√üen-Auswertung
                                </label>
                            </div>
                        </div>

                        <!-- Spalte 2 (rechte Seite): Warnungen -->
                        <div class="col-md-6">
                            <h5 class="mb-3">Zu generierende Warnungen/Hinweise</h5>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="warn_entlassdatum" name="warn_entlassdatum" {% if warn_entlassdatum %}checked{% endif %}>
                                <label class="form-check-label" for="warn_entlassdatum">
                                    ‚û°Ô∏è Ung√ºnstig verschobene Entlassdaten
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="warn_aufnahmedatum" name="warn_aufnahmedatum" {% if warn_aufnahmedatum %}checked{% endif %}>
                                <label class="form-check-label" for="warn_aufnahmedatum">
                                    ‚¨ÖÔ∏è Ung√ºnstig verschobene Aufnahmedaten
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="warn_klassenwechsel" name="warn_klassenwechsel" {% if warn_klassenwechsel %}checked{% endif %}>
                                <label class="form-check-label" for="warn_klassenwechsel">
                                    üîÑ Klassenwechsel
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="warn_new_students" name="warn_new_students" {% if warn_new_students %}checked{% endif %}>
                                <label class="form-check-label" for="warn_new_students">
                                    üÜï neue Sch√ºler
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons am Ende, unter der row -->
                    <div class="btn-group mt-4">
                        <button type="submit" class="btn btn-primary">‚ñ∂Ô∏è Verarbeiten</button>
                        <button id="generateEmails" type="button" class="btn btn-info">‚úç Emails Generieren</button>
                        <button id="sendEmails" type="button" class="btn btn-success">üì® Emails Senden</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="container mt-5">
            {% if errors %}
            <div class="alert alert-danger" role="alert">
                <ul>
                    {% for error in errors %}
                    <li>‚ùå {{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if warnings_messages %}
            <div class="alert alert-warning" role="alert">
                <ul>
                    {% for warning in warnings_messages %}
                    <li>‚ö†Ô∏è {{ warning }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if confirmation %}
            <div class="alert alert-success" role="alert">
                ‚úÖ {{ confirmation }}
            </div>
            {% endif %}
        </div>

        {% if warnings %}
        <h3 class="mt-5">Warnungen:</h3>
        <table class="table table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Sch√ºler</th>
                    <th>Klasse</th>
                    <th>Warnung</th>
                    <th>Details</th>
                    <th>Klassenlehrkr√§fte</th>
                </tr>
            </thead>
            <tbody>
                {% for warning in warnings %}
                <tr>
                    <td>{{ warning['Vorname'] }} {{ warning['Nachname'] }}</td>
                    <td>{{ warning.get('Klasse', 'N/A') }}</td>
                    <td>{{ warning['warning_message'] }}</td>
                    <td>
                        {% if 'Zeitraum_nicht_dokumentiert' in warning %}
                        <strong>Zeitraum nicht dokumentiert:</strong> {{ warning['Zeitraum_nicht_dokumentiert'] }}<br>
                        {% endif %}
                        {% if 'neues_entlassdatum' in warning %}
                        <strong>Neues Entlassdatum:</strong> {{ warning['neues_entlassdatum'] }}<br>
                        <strong>Altes Entlassdatum:</strong> {{ warning['altes_entlassdatum'] }}<br>
                        {% endif %}
                        {% if 'neues_aufnahmedatum' in warning %}
                        <strong>Neues Aufnahmedatum:</strong> {{ warning['neues_aufnahmedatum'] }}<br>
                        <strong>Altes Aufnahmedatum:</strong> {{ warning['altes_aufnahmedatum'] }}<br>
                        {% endif %}
                        {% if 'new_student' in warning and warning.new_student %}
                        <strong>Aufnahmedatum:</strong> {{ warning['Aufnahmedatum'] }}<br>
                        {% endif %}
                        {% if 'neue_klasse' in warning %}
                        <strong>Alte Klasse:</strong> {{ warning.get('alte_klasse', 'N/A') }}<br>
                        <strong>Neue Klasse:</strong> {{ warning.get('neue_klasse', 'N/A') }}
                        {% endif %}
                    </td>
                    <td>
                        <strong>Klassenlehrkraft 1:</strong> {{ warning['Klassenlehrkraft_1'] }} ({{ warning['Klassenlehrkraft_1_Email'] }})<br>
                        <strong>Klassenlehrkraft 2:</strong> {{ warning['Klassenlehrkraft_2'] }} ({{ warning['Klassenlehrkraft_2_Email'] }})
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}



        {% if emails %}
        <h3 class="mt-5">Generierte Emails:</h3>
        <ul class="list-group">
            {% for email in emails %}
            <li class="list-group-item">
                <strong>An:</strong> {{ email['to']|join(', ') }}<br>
                <strong>Betreff:</strong> {{ email['subject'] }}<br>
                <strong>Text:</strong><br>
                <div class="email-body">
                    {{ email['body']|safe }}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3" style="height: 60px;">
            <button id="toggleEditor" class="btn btn-secondary w-100 mr-2">‚úâÔ∏è Email-Vorlagen Editor</button>
            {% if enable_upload %}<button id="toggleUploadArea" class="btn btn-warning w-100 mx-2">‚¨ÜÔ∏è Dateien Hochladen</button>{% endif %}
            <button id="toggleShortcutCreator" class="btn btn-info w-100 mx-2">#Ô∏è‚É£üîóBefehl- und Verkn√ºpfungs-Erstelltool</button>
            <button id="toggle-settings" class="btn btn-primary w-100 ml-2">‚öôÔ∏è Einstellungen</button>
        </div>

        <div id="settingsPanel" class="mt-4" style="display: none;">
            <h4 class="mb-4">‚öôÔ∏è Einstellungen</h4>
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                {% if not no_directory_change %}
                <li class="nav-item">
                    <a class="nav-link active" id="directories-tab" data-toggle="tab" href="#directories" role="tab" aria-controls="directories" aria-selected="true">üìÅ Verzeichnisse</a>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link" id="processing-tab" data-toggle="tab" href="#processing" role="tab" aria-controls="processing" aria-selected="false">üõ†Ô∏è Verarbeitung</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="warnings-tab" data-toggle="tab" href="#warnings" role="tab" aria-controls="warnings" aria-selected="false">‚ö†Ô∏è Warnungen</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="console-tab" data-toggle="tab" href="#console" role="tab" aria-controls="console" aria-selected="false">üéõÔ∏è Konsole</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="smtp-tab" data-toggle="tab" href="#smtp" role="tab" aria-controls="smtp" aria-selected="false">üì§ SMTP</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="oauth-tab" data-toggle="tab" href="#oauth" role="tab" aria-controls="oauth" aria-selected="false">üîê OAuth</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="admin-tab" data-toggle="tab" href="#admin" role="tab" aria-controls="admin" aria-selected="false"> üìß Admin-Kontakt</a>
                </li>
            </ul>
            <div class="tab-content mt-3">
                <!-- Standard-Verzeichnisse -->
                {% if not no_directory_change %}
                <div class="tab-pane fade show active" id="directories" role="tabpanel" aria-labelledby="directories-tab">
                    <form id="form-directories">

                        <!-- √úberschrift f√ºr Import-Verzeichnisse -->
                        <h5 class="mb-3">Import-Verzeichnisse</h5>

                        <!-- Klassendatenverzeichnis -->
                        <div class="form-group">
                            <label for="classes_directory">üè´ Klassendatenverzeichnis:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="classes_directory" name="classes_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="classes_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Lehrerdatenverzeichnis -->
                        <div class="form-group">
                            <label for="teachers_directory">üßë‚Äçüè´ Lehrerdatenverzeichnis:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="teachers_directory" name="teachers_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="teachers_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Schild Exporte -->
                        <div class="form-group">
                            <label for="schildexport_directory">üü¶üì• Schild Exporte:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="schildexport_directory" name="schildexport_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="schildexport_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Attestpflicht-Datei-Verzeichnis -->
                        <div class="form-group">
                            <label for="attest_file_directory">üìë Attestpflicht-Datei-Verzeichnis:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="attest_file_directory" name="attest_file_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="attest_file_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>
                        <!-- Nachteilsausgleich-Verzeichnis -->
                        <div class="form-group">
                            <label for="nachteilsausgleich_file_directory">‚ôø Nachteilsausgleich-Datei-Verzeichnis: </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="nachteilsausgleich_file_directory" name="nachteilsausgleich_file_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="nachteilsausgleich_file_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>


                        <!-- Trennlinie zwischen den beiden Bereichen -->
                        <hr class="my-4">

                        <!-- √úberschrift f√ºr Export-Verzeichnisse -->
                        <h5 class="mb-3">Export-Verzeichnisse</h5>

                        <!-- Logverzeichnis -->
                        <div class="form-group">
                            <label for="log_directory">üìã Logverzeichnis:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="log_directory" name="log_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="log_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Excel-Verzeichnis -->
                        <div class="form-group">
                            <label for="xlsx_directory">ùÑú Excel-Verzeichnis:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="xlsx_directory" name="xlsx_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="xlsx_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>

                        <!-- WebUntis Importe -->
                        <div class="form-group">
                            <label for="import_directory">üüßüì§ WebUntis Importe:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="import_directory" name="import_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="import_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Klassengr√∂√üen-Verzeichnis -->
                        <div class="form-group">
                            <label for="class_size_directory">üìä Klassengr√∂√üen-Verzeichnis:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="class_size_directory" name="class_size_directory" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-secondary" data-directory-input="class_size_directory">Durchsuchen</button>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
                {% endif %}

                <!-- Verarbeitung -->
                <div class="tab-pane fade" id="processing" role="tabpanel" aria-labelledby="processing-tab">
                    <form id="form-processing">
                        <h5 class="mb-3">Verarbeitungseinstellungen</h5>
                        <div class="form-group">
                            <label for="use_abschlussdatum">üóìÔ∏è Immer Vorraussichtliches Abschlussdatum verwenden:</label>
                            <select class="form-control" id="use_abschlussdatum" name="use_abschlussdatum">
                                <option value="True">Ja</option>
                                <option value="False">Nein</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="enable_attestpflicht_column">üìÑ Immer Attestpflicht-Spalte hinzuf√ºgen:</label>
                            <select class="form-control" id="enable_attestpflicht_column" name="enable_attestpflicht_column">
                                <option value="True">Ja</option>
                                <option value="False">Nein</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="enable_nachteilsausgleich_column">‚ôø Immer Nachteilsausgleich-Spalte hinzuf√ºgen:</label>
                            <select class="form-control" id="enable_nachteilsausgleich_column" name="enable_nachteilsausgleich_column">
                                <option value="True">Ja</option>
                                <option value="False">Nein</option>
                            </select>
                        </div>
                        <h5 class="mb-3">Zus√§tzliche Exporte</h5>
                        <div class="form-group">
                            <label for="create_second_file">üîé Immer Datei zur Analyse fehlender Entlassdaten erstellen:</label>
                            <select class="form-control" id="create_second_file" name="create_second_file">
                                <option value="True">Ja</option>
                                <option value="False">Nein</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="create_class_size_file">üìä Immer Klassengr√∂√üen ermitteln:</label>
                            <select class="form-control" id="create_class_size_file" name="create_class_size_file">
                                <option value="True">Ja</option>
                                <option value="False">Nein</option>
                            </select>
                        </div>
                    </form>
                </div>
                <!-- Warnungen -->
                <div class="tab-pane fade" id="warnings" role="tabpanel" aria-labelledby="warnings-tab">
                    <form id="form-warnings">
                        <div class="form-group">
                            <label for="warn_entlassdatum">‚û°Ô∏è Immer Warnungen f√ºr Entlassdatum generieren:</label>
                            <select class="form-control" id="warn_entlassdatum" name="warn_entlassdatum">
                                <option value="True">Aktiv</option>
                                <option value="False">Inaktiv</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="warn_aufnahmedatum">‚¨ÖÔ∏è Immer Warnungen f√ºr Aufnahmedatum generieren:</label>
                            <select class="form-control" id="warn_aufnahmedatum" name="warn_aufnahmedatum">
                                <option value="True">Aktiv</option>
                                <option value="False">Inaktiv</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="warn_klassenwechsel">üîÑ Immer Warnungen f√ºr Klassenwechsel generieren:</label>
                            <select class="form-control" id="warn_klassenwechsel" name="warn_klassenwechsel">
                                <option value="True">Aktiv</option>
                                <option value="False">Inaktiv</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="warn_new_students">üÜï Immer Warnungen f√ºr neue Sch√ºler generieren:</label>
                            <select class="form-control" id="warn_new_students" name="warn_new_students">
                                <option value="True">Aktiv</option>
                                <option value="False">Inaktiv</option>
                            </select>
                        </div>
                    </form>
                </div>
                <!-- Konsole -->
                <div class="tab-pane fade" id="console" role="tabpanel" aria-labelledby="console-tab">
                    <form id="form-console">
                        <div class="form-group">
                            <label for="timeframe_hours">‚è≥ Zeitfenster (in Stunden):</label>
                            <input type="number" class="form-control" id="timeframe_hours" name="timeframe_hours">
                        </div>
                    </form>
                </div>
                <!-- SMTP -->
                <div class="tab-pane fade" id="smtp" role="tabpanel" aria-labelledby="smtp-tab">
                    <form id="form-smtp">
                        <div class="form-group">
                            <label for="smtp_server">üñß SMTP-Server:</label>
                            <input type="text" class="form-control" id="smtp_server" name="smtp_server">
                        </div>
                        <div class="form-group">
                            <label for="smtp_port">üèó SMTP-Port:</label>
                            <input type="number" class="form-control" id="smtp_port" name="smtp_port">
                        </div>
                        <div class="form-group">
                            <label for="smtp_user">üë§ SMTP-Benutzername:</label>
                            <input type="text" class="form-control" id="smtp_user" name="smtp_user">
                        </div>
                        <div class="form-group">
                            <label for="smtp_password">üîë SMTP-Passwort:</label>
                            <input type="password" class="form-control" id="smtp_password" name="smtp_password">
                        </div>
                        <div class="form-group">
                            <label for="smtp_encryption">üõ°Ô∏è SMTP-Verschl√ºsselung:</label>
                            <select class="form-control" id="smtp_encryption" name="smtp_encryption">
                                <option value="starttls">STARTTLS</option>
                                <option value="ssl">SSL</option>
                            </select>
                        </div>
                    </form>
                </div>
                <!-- OAuth -->
                <div class="tab-pane fade" id="oauth" role="tabpanel" aria-labelledby="oauth-tab">
                    <form id="form-oauth">
                        <div class="form-group">
                            <label for="use_oauth">üîê O-Auth verwenden:</label>
                            <select class="form-control" id="use_oauth" name="use_oauth">
                                <option value="True">Ja</option>
                                <option value="False">Nein</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="credentials_path">üîë Pfad zu den Anmeldedaten:</label>
                            <input type="text" class="form-control" id="credentials_path" name="credentials_path">
                        </div>
                    </form>
                </div>
                <!-- Admin-Kontakt -->
                <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
                    <form id="form-admin">
                        <div class="form-group">
                            <label for="admin_email">üì® Admin-E-Mail-Adresse:</label>
                            <input type="email" class="form-control" id="admin_email" name="admin_email">
                        </div>
                    </form>
                </div>
            </div>
            <button id="saveSettings" class="btn btn-primary mt-4">Einstellungen speichern</button>
        </div>

        <div id="emailEditor" class="mt-4" style="display: none;">
            <h4 class="mb-4">‚úâÔ∏è Email-Vorlagen Editor</h4>
            <ul class="nav nav-tabs" id="emailTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="entlass-tab" data-toggle="tab" href="#entlass" role="tab" aria-controls="entlass" aria-selected="true">‚û°Ô∏è Entlassdatum</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="aufnahme-tab" data-toggle="tab" href="#aufnahme" role="tab" aria-controls="aufnahme" aria-selected="false">‚¨ÖÔ∏è Aufnahmedatum</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="klassenwechsel-tab" data-toggle="tab" href="#klassenwechsel" role="tab" aria-controls="klassenwechsel" aria-selected="false">üîÑ Klassenwechsel</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="newstudent-tab" data-toggle="tab" href="#newstudent" role="tab" aria-controls="newstudent" aria-selected="false">üÜï Neue Sch√ºler</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="email-info-tab" data-toggle="tab" href="#email-info" role="tab" aria-controls="email-info" aria-selected="false">üóùÔ∏è‚ÑπÔ∏èSchl√ºssel-Info</a>
                </li>
            </ul>
            <div class="tab-content mt-3">
                <!-- Entlassdatum -->
                <div class="tab-pane fade show active" id="entlass" role="tabpanel" aria-labelledby="entlass-tab">
                    <form id="entlassForm">
                        <div class="form-group">
                            <label for="subjectEntlassdatum">üìß Betreff:</label>
                            <input type="text" class="form-control" id="subjectEntlassdatum" name="subject_entlassdatum">
                        </div>
                        <div class="form-group">
                            <label for="bodyEntlassdatum">üìú Nachricht:</label>
                            <div id="editorBodyEntlassdatum" class="quill-editor"></div>
                            <textarea id="bodyEntlassdatum" name="body_entlassdatum" class="form-control d-none"></textarea>
                        </div>
                    </form>
                </div>
                <!-- Aufnahmedatum -->
                <div class="tab-pane fade" id="aufnahme" role="tabpanel" aria-labelledby="aufnahme-tab">
                    <form id="aufnahmeForm">
                        <div class="form-group">
                            <label for="subjectAufnahmedatum">üìß Betreff:</label>
                            <input type="text" class="form-control" id="subjectAufnahmedatum" name="subject_aufnahmedatum">
                        </div>
                        <div class="form-group">
                            <label for="bodyAufnahmedatum">üìú Nachricht:</label>
                            <div id="editorBodyAufnahmedatum" class="quill-editor"></div>
                            <textarea id="bodyAufnahmedatum" name="body_aufnahmedatum" class="form-control d-none"></textarea>
                        </div>
                    </form>
                </div>
                <!-- Klassenwechsel -->
                <div class="tab-pane fade" id="klassenwechsel" role="tabpanel" aria-labelledby="klassenwechsel-tab">
                    <form id="klassenwechselForm">
                        <div class="form-group">
                            <label for="subjectKlassenwechsel">üìß Betreff:</label>
                            <input type="text" class="form-control" id="subjectKlassenwechsel" name="subject_klassenwechsel">
                        </div>
                        <div class="form-group">
                            <label for="bodyKlassenwechsel">üìú Nachricht:</label>
                            <div id="editorBodyKlassenwechsel" class="quill-editor"></div>
                            <textarea id="bodyKlassenwechsel" name="body_klassenwechsel" class="form-control d-none"></textarea>
                        </div>
                    </form>
                </div>
                <!-- Neue Sch√ºler -->
                <div class="tab-pane fade" id="newstudent" role="tabpanel" aria-labelledby="newstudent-tab">
                    <form id="newStudentForm">
                        <div class="form-group">
                            <label for="subjectNewStudent">üìß Betreff:</label>
                            <input type="text" class="form-control" id="subjectNewStudent" name="subject_new_student">
                        </div>
                        <div class="form-group">
                            <label for="bodyNewStudent">üìú Nachricht:</label>
                            <div id="editorBodyNewStudent" class="quill-editor"></div>
                            <textarea id="bodyNewStudent" name="body_new_student" class="form-control d-none"></textarea>
                        </div>
                    </form>
                </div>
                <!-- Schl√ºssel-Info -->
                <div class="tab-pane fade" id="email-info" role="tabpanel" aria-labelledby="email-info-tab">
                    <h5>Verf√ºgbare Schl√ºssel</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Kategorie</th>
                                <th>Schl√ºssel</th>
                                <th>Beschreibung</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Generelle Schl√ºssel -->
                            <tr>
                                <td rowspan="6">Generell</td>
                                <td>$Vorname</td>
                                <td>Vorname des Sch√ºlers/der Sch√ºlerin</td>
                            </tr>
                            <tr>
                                <td>$Nachname</td>
                                <td>Nachname des Sch√ºlers/der Sch√ºlerin</td>
                            </tr>
                            <tr>
                                <td>$Klasse</td>
                                <td>Klasse des Sch√ºlers/der Sch√ºlerin</td>
                            </tr>
                            <tr>
                                <td>$Klassenlehrkraft_1</td>
                                <td>Name der ersten Klassenlehrkraft</td>
                            </tr>
                            <tr>
                                <td>$Klassenlehrkraft_1_Email</td>
                                <td>E-Mail-Adresse der ersten Klassenlehrkraft</td>
                            </tr>
                            <tr>
                                <td>$Klassenlehrkraft_2</td>
                                <td>Name der zweiten Klassenlehrkraft</td>
                            </tr>
                            <!-- Warnung Entlassdatum -->
                            <tr>
                                <td rowspan="3">Entlassdatum</td>
                                <td>$neues_entlassdatum</td>
                                <td>Neues Entlassdatum</td>
                            </tr>
                            <tr>
                                <td>$altes_entlassdatum</td>
                                <td>Altes Entlassdatum</td>
                            </tr>
                            <tr>
                                <td>$zeitraum_text</td>
                                <td>Zus√§tzlicher Zeitraumtext (falls verf√ºgbar)</td>
                            </tr>
                            <!-- Warnung Aufnahmedatum -->
                            <tr>
                                <td rowspan="3">Aufnahmedatum</td>
                                <td>$neues_aufnahmedatum</td>
                                <td>Neues Aufnahmedatum</td>
                            </tr>
                            <tr>
                                <td>$altes_aufnahmedatum</td>
                                <td>Altes Aufnahmedatum</td>
                            </tr>
                            <tr>
                                <td>$zeitraum_text</td>
                                <td>Zus√§tzlicher Zeitraumtext (falls verf√ºgbar)</td>
                            </tr>
                            <!-- Warnung Klassenwechsel -->
                            <tr>
                                <td rowspan="2">Klassenwechsel</td>
                                <td>$alte_klasse</td>
                                <td>Alte Klasse des Sch√ºlers/der Sch√ºlerin</td>
                            </tr>
                            <tr>
                                <td>$neue_klasse</td>
                                <td>Neue Klasse des Sch√ºlers/der Sch√ºlerin</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <button id="saveEmailTemplates" class="btn btn-primary mt-4">Speichern</button>
        </div>
        <div id="shortcutCreator" class="mt-4" style="display: none;">
            <h4 class="mb-4">#Ô∏è‚É£üîó Befehl- und Verkn√ºpfungs-Erstelltool </h4>
            <div class="card-body">
                <p class="text-muted">
                    Mit diesem Tool k√∂nnen Sie Befehle erstellen, um das Programm direkt mit bestimmten Konfigurationsoptionen
                    (Argumenten) auszuf√ºhren ohne diese im Browser ausl√∂sen zu m√ºssen. <br />Au√üerdem k√∂nnen Sie eine Verkn√ºpfung
                    erstellen, die bequem vom Desktop oder einem beliebigen anderen Ort aus aufgerufen werden kann. <br />
                    F√ºgen Sie gew√ºnschte Argumente hinzu, und generieren Sie entweder einen Befehl zum Ausf√ºhren in der Windows-Eingabeaufforderung (CMD) oder eine Verkn√ºpfung.
                </p>
                <form id="shortcutForm">
                    <div class="form-group">
                        <label for="exePath">Pfad der Ausf√ºhrungs-Datei:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="exePath" value="Schild-WebUntis-Tool.exe" placeholder="Pfad zur ausf√ºhrbaren Datei">
                        </div>
                        <small id="fileValidationMessage" class="form-text text-danger"></small>
                    </div>
                    <div class="form-group">
                        <label for="availableArgs">Verf√ºgbare Argumente:</label>
                        <div class="input-group">
                            <select id="availableArgs" class="form-control">
                                <!-- Arguments will be populated dynamically -->
                            </select>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-secondary" id="addArg">Argument hinzuf√ºgen</button>
                            </div>
                        </div>
                        <small id="argDescription" class="form-text text-muted">Select an argument to see its description.</small>
                    </div>
                    <div class="form-group">
                        <label for="args">Verwendete Argumente:</label>
                        <input type="text" class="form-control" id="args" placeholder="Argumente hier hinzuf√ºgen">
                    </div>
                    <div class="form-group">
                        <label for="outputCommand">Generierter Befehl:</label>
                        <input type="text" class="form-control" id="outputCommand" readonly>
                    </div>
                    <button type="button" class="btn btn-primary" id="generateCommand">Befehl Generieren (f√ºr CMD)</button>
                    <button type="button" class="btn btn-success" id="createShortcut">Verkn√ºpfung Erstellen (Desktop)</button>
                </form>
            </div>
        </div>
        <div id="uploadArea" class="mt-4" style="display: none;">
            <h4 class="mb-4">‚¨ÜÔ∏è Dateien Hochladen</h4>
            <p>W√§hlen Sie die Dateien aus, die Sie hochladen m√∂chten:</p>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="classDataFiles">üè´ Klassendaten hochladen:</label>
                    <div class="input-group">
                        <input type="file" class="form-control-file" id="classDataFiles" name="class_data_files" multiple>
                        <div class="input-group-append">
                            <button type="button" class="btn btn-link" data-toggle="collapse" data-target="#classDataHelp" aria-expanded="false" aria-controls="classDataHelp">
                                ‚ÑπÔ∏è Hilfestellung
                            </button>
                        </div>
                    </div>
                    <div id="classDataHelp" class="collapse mt-2">
                        <p class="text-muted">
                            So erstellen Sie den Stammdaten-Export der Klassen:
                        </p>
                        <ol>
                            <li>
                                Gehen Sie in WebUntis zu <em>Stammdaten ‚Üí Klassen</em>.
                            </li>
                            <li>
                                Kopieren Sie die Tabelle in eine Excel-Datei.
                            </li>
                            <li>
                                Die Datei sollte folgende Spalten in genau dieser Reihenfolge enthalten (nichts umbenennen):
                            </li>
                        </ol>
                        <pre><code>Auswahl, [eine Leere Spalte], Klasse, Langname, Alias, Jahrgangsstufe, Text, Klassenlehrkraft, Klassenlehrkraft, Abteilung, Von, Bis</code></pre>
                        <p>
                            <b>Hinweis:</b> Die Tabelle aus WebUntis kann einfach kopiert und eingef√ºgt werden, ohne zus√§tzliche √Ñnderungen vorzunehmen.
                        </p>
                        <p>
                            Exportieren Sie diese Excel-Datei anschlie√üend mit Excel als <code>.csv</code>.
                        </p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="teacherDataFiles">üßë‚Äçüè´ Lehrerdaten hochladen:</label>
                    <div class="input-group">
                        <input type="file" class="form-control-file" id="teacherDataFiles" name="teacher_data_files" multiple>
                        <div class="input-group-append">
                            <button type="button" class="btn btn-link" data-toggle="collapse" data-target="#teacherDataHelp" aria-expanded="false" aria-controls="teacherDataHelp">
                                ‚ÑπÔ∏è Hilfestellung
                            </button>
                        </div>
                    </div>
                    <div id="teacherDataHelp" class="collapse mt-2">
                        <p class="text-muted">
                            So erstellen Sie den Stammdaten-Export der Lehrkr√§fte:
                        </p>
                        <ol>
                            <li>
                                Gehen Sie in WebUntis zu <em>Stammdaten ‚Üí Lehrkr√§fte</em>.
                            </li>
                            <li>
                                Scrollen Sie nach unten und klicken Sie auf <em>Berichte</em>.
                            </li>
                            <li>
                                W√§hlen Sie den <strong>CSV-Bericht</strong> bei "Lehrkr√§fte".
                            </li>
                            <li>
                                **Wichtiger Hinweis:** Das Feld f√ºr die E-Mail-Adressen muss mit den Dienst-E-Mail-Adressen der Kollegen gef√ºllt sein, damit es nachher funktioniert.
                            </li>
                        </ol>
                    </div>
                </div>
                <div class="form-group">
                    <label for="schildExportFiles">üü¶ Schild-Export Dateien hochladen:</label>
                    <div class="input-group">
                        <input type="file" class="form-control-file" id="schildExportFiles" name="schild_export_files" multiple>
                        <div class="input-group-append">
                            <button type="button" class="btn btn-link" data-toggle="collapse" data-target="#schildExportHelp" aria-expanded="false" aria-controls="schildExportHelp">
                                ‚ÑπÔ∏è Hilfestellung
                            </button>
                        </div>
                    </div>
                    <div id="schildExportHelp" class="collapse mt-2">
                        <p class="text-muted">
                            So erstellen Sie den Schild NRW Export:
                        </p>
                        <ul>
                            <li><strong>Auswahlsfilter in SchildNRW und Export:</strong></li>
                            <li>
                                Unten bei Laufbahninfo bei Schuljahr das aktuelle Schuljahr ausw√§hlen.
                            </li>
                            <li>
                                Oben rechts bei Status: <em>Aktiv</em>, <em>Abschluss</em> und <em>Abg√§nger</em> anw√§hlen.
                            </li>
                            <li>
                                Speichern Sie diesen Filter, damit Sie ihn sp√§ter √ºber "Auswahl - Vorhandene Filter laden" wieder verwenden k√∂nnen.
                            </li>
                            <li>
                                Export aus SchildNRW als Text/Excel Export, jedoch unbedingt mit der manuell eingegebenen Dateiendung <code>.csv</code>.
                            </li>
                            <li>
                                Als Separator ist <code>;</code> zu w√§hlen.
                            </li>
                        </ul>
                        <p><b>Erforderliche Daten (in dieser Reihenfolge):</b></p>
                        <pre><code>Interne ID-Nummer, Nachname, Vorname, Klasse, Klassenlehrer, Geburtsdatum, Geschlecht, vorrauss. Abschluss, Aufnahmedatum, Entlassdatum, Vollj√§hrig, Schulpflicht erf√ºllt, Status</code></pre>
                        <p><b>Optionale Daten:</b></p>
                        <pre><code>E-Mail (privat), Telefon-Nr., Fax-Nr., Stra√üe, Postleitzahl, Ortsname</code></pre>
                        <p><b>Hinweise:</b></p>
                        <ul>
                            <li>
                                Der Export funktioniert nicht, wenn die Datei als Excel-Datei exportiert und anschlie√üend als <code>.csv</code> gespeichert wird.
                            </li>
                            <li>
                                Erg√§nzen Sie die Endung <code>.csv</code> manuell, nachdem Sie den Exporttyp <em>Textdatei</em> ausgew√§hlt haben.
                            </li>
                            <li>
                                Speichern Sie die Exporteinstellungen als Vorlage ab, um sie sp√§ter schneller verwenden zu k√∂nnen.
                            </li>
                        </ul>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Dateien hochladen</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const panels = {
                settingsPanel: document.getElementById("settingsPanel"),
                emailEditor: document.getElementById("emailEditor"),
                shortcutCreator: document.getElementById("shortcutCreator"),
            };

            const toggleButtons = {
                toggleSettingsButton: document.getElementById("toggle-settings"),
                toggleEditorButton: document.getElementById("toggleEditor"),
                toggleShortcutButton: document.getElementById("toggleShortcutCreator"),
            };

            const settingsTabs = document.querySelectorAll("#settingsPanel .nav-link");
            const settingsContentPanels = document.querySelectorAll("#settingsPanel .tab-content > .tab-pane");

            function togglePanel(panelKey) {
                Object.entries(panels).forEach(([key, panel]) => {
                    if (key === panelKey) {
                        // Show the selected panel
                        panel.style.display = panel.style.display === "none" || panel.style.display === "" ? "block" : "none";
                        if (panelKey === "settingsPanel") {
                            activateFirstTab();
                        }
                    } else {
                        // Hide other panels
                        panel.style.display = "none";
                    }
                });
            }

            function activateFirstTab() {
                // Reset all tabs and content panels
                settingsTabs.forEach((tab) => tab.classList.remove("active"));
                settingsContentPanels.forEach((content) => content.classList.remove("show", "active"));

                // Activate the first tab and its content
                if (settingsTabs.length > 0 && settingsContentPanels.length > 0) {
                    settingsTabs[0].classList.add("active");
                    settingsContentPanels[0].classList.add("show", "active");
                }
            }

            // Event listener for Settings Panel
            toggleButtons.toggleSettingsButton.addEventListener("click", function () {
                togglePanel("settingsPanel");
            });

            // Event listener for Email Editor
            toggleButtons.toggleEditorButton.addEventListener("click", function () {
                togglePanel("emailEditor");
            });

            // Event listener for Shortcut Creator
            toggleButtons.toggleShortcutButton.addEventListener("click", function () {
                togglePanel("shortcutCreator");
            });

            // Ensure all panels are initially hidden
            Object.values(panels).forEach((panel) => (panel.style.display = "none"));
        });


        document.addEventListener("DOMContentLoaded", function () {
            // Initialisiere WYSIWYG-Editoren
            const editorOptions = { theme: 'snow' };
            const editorBodyEntlassdatum = new Quill('#editorBodyEntlassdatum', { theme: 'snow' });
            const editorBodyAufnahmedatum = new Quill('#editorBodyAufnahmedatum', { theme: 'snow' });
            const editorBodyKlassenwechsel = new Quill('#editorBodyKlassenwechsel', { theme: 'snow' });
            const editorBodyNewStudent = new Quill('#editorBodyNewStudent', { theme: 'snow' });

            // Load templates dynamically
            fetch("/get_templates")
                .then(response => response.json())
                .then(data => {
                    // Populate subject fields
                    document.getElementById("subjectEntlassdatum").value = data.subject_entlassdatum || "";
                    document.getElementById("subjectAufnahmedatum").value = data.subject_aufnahmedatum || "";
                    document.getElementById("subjectKlassenwechsel").value = data.subject_klassenwechsel || "";
                    document.getElementById("subjectNewStudent").value = data.subject_new_student || "";

                    // Populate body fields in Quill editors
                    editorBodyEntlassdatum.root.innerHTML = data.body_entlassdatum || "";
                    editorBodyAufnahmedatum.root.innerHTML = data.body_aufnahmedatum || "";
                    editorBodyKlassenwechsel.root.innerHTML = data.body_klassenwechsel || "";
                    editorBodyNewStudent.root.innerHTML = data.body_new_student || "";
                })
                .catch(error => {
                    console.error("Error loading email templates:", error);
                    alert("Fehler beim Laden der E-Mail-Vorlagen.");
                });

            // Save templates
            document.getElementById("saveEmailTemplates").addEventListener("click", function () {
                // Synchronisiere Quill-Inhalte
                document.getElementById('bodyEntlassdatum').value = editorBodyEntlassdatum.root.innerHTML;
                document.getElementById('bodyAufnahmedatum').value = editorBodyAufnahmedatum.root.innerHTML;
                document.getElementById('bodyKlassenwechsel').value = editorBodyKlassenwechsel.root.innerHTML;
                document.getElementById('bodyNewStudent').value = editorBodyNewStudent.root.innerHTML;

                const formData = new FormData();
                formData.append("subject_entlassdatum", document.getElementById("subjectEntlassdatum").value);
                formData.append("body_entlassdatum", document.getElementById("bodyEntlassdatum").value);
                formData.append("subject_aufnahmedatum", document.getElementById("subjectAufnahmedatum").value);
                formData.append("body_aufnahmedatum", document.getElementById("bodyAufnahmedatum").value);
                formData.append("subject_klassenwechsel", document.getElementById("subjectKlassenwechsel").value);
                formData.append("body_klassenwechsel", document.getElementById("bodyKlassenwechsel").value);
                formData.append("subject_new_student", document.getElementById("subjectNewStudent").value);
                formData.append("body_new_student", document.getElementById("bodyNewStudent").value);

                fetch("/update_templates", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                    })
                    .catch(error => {
                        console.error("Error saving email templates:", error);
                        alert("Fehler beim Speichern der E-Mail-Vorlagen.");
                    });
            });

            // Tabs f√ºr den E-Mail-Editor initialisieren
            const emailTabs = document.querySelectorAll('#emailTabs .nav-link');
            emailTabs.forEach(tab => {
                tab.addEventListener("click", function (e) {
                    e.preventDefault();

                    // Aktive Tabs wechseln
                    emailTabs.forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");

                    // Content-Panels wechseln
                    const allPanels = document.querySelectorAll(".tab-content > .tab-pane");
                    allPanels.forEach(panel => panel.classList.remove("show", "active"));
                    const targetPanel = document.querySelector(tab.getAttribute("href"));
                    if (targetPanel) {
                        targetPanel.classList.add("show", "active");
                    }
                });
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const settingsPanel = document.getElementById("settingsPanel");
            const saveSettingsButton = document.getElementById("saveSettings");
            const toggleSettingsButton = document.getElementById("toggle-settings");
            const directoryPicker = document.getElementById("directory-picker");

            async function selectDirectory(inputId) {
                if (window.showDirectoryPicker) {
                    try {
                        const directoryHandle = await window.showDirectoryPicker();
                        const formData = new FormData();
                        formData.append("directoryName", directoryHandle.name);

                        // Optional: Sende den vollst√§ndigen Pfad an das Backend
                        const response = await fetch("/process-directory", {
                            method: "POST",
                            body: formData,
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const directoryPath = result.fullPath || directoryHandle.name;

                            // Konvertiere Backslashes in Forward Slashes (INI-kompatibel)
                            const formattedPath = directoryPath.replace(/\\/g, "/");
                            document.getElementById(inputId).value = formattedPath; // Aktualisiere das Eingabefeld
                        } else {
                            console.error("Error processing directory:", response.statusText);
                        }
                    } catch (error) {
                        console.error("Directory selection was cancelled or failed:", error);
                    }
                } else {
                    alert("Your browser does not support the directory picker. Please enter manually.");
                }
            }

            // Tabs und Inhalte initialisieren
            const tabs = [
                { id: "directories", form: "form-directories" },
                { id: "processing", form: "form-processing" },
                { id: "warnings", form: "form-warnings" },
                { id: "console", form: "form-console" },
                { id: "smtp", form: "form-smtp" },
                { id: "oauth", form: "form-oauth" },
                { id: "admin", form: "form-admin" },
            ];

            // Einstellungen laden
            async function loadSettings() {
                try {
                    const response = await fetch("/load-settings");
                    if (response.ok) {
                        const settings = await response.json();

                        // Map keys to forms
                        const keyToFormId = {
                            // Directories
                            "classes_directory": "form-directories",
                            "teachers_directory": "form-directories",
                            "log_directory": "form-directories",
                            "xlsx_directory": "form-directories",
                            "import_directory": "form-directories",
                            "schildexport_directory": "form-directories",
                            "class_size_directory": "form-directories",
                            "attest_file_directory": "form-directories",
                            "nachteilsausgleich_file_directory": "form-directories",
                            // ProcessingOptions
                            "use_abschlussdatum": "form-processing",
                            "create_second_file": "form-processing",
                            "create_class_size_file": "form-processing",
                            "enable_attestpflicht_column": "form-processing",
                            "enable_nachteilsausgleich_column": "form-processing",
                            // Warnings
                            "warn_entlassdatum": "form-warnings",
                            "warn_aufnahmedatum": "form-warnings",
                            "warn_klassenwechsel": "form-warnings",
                            "warn_new_students": "form-warnings",
                            // Console
                            "timeframe_hours": "form-console",
                            // Email settings
                            "smtp_server": "form-smtp",
                            "smtp_port": "form-smtp",
                            "smtp_user": "form-smtp",
                            "smtp_password": "form-smtp",
                            "smtp_encryption": "form-smtp",
                            // OAuth
                            "use_oauth": "form-oauth",
                            "credentials_path": "form-oauth",
                            // Admin
                            "admin_email": "form-admin",
                        };

                        // Loop over settings and populate forms
                        Object.entries(settings).forEach(([section, sectionValues]) => {
                            Object.entries(sectionValues).forEach(([key, value]) => {
                                const formId = keyToFormId[key];
                                if (formId) {
                                    const form = document.getElementById(formId);
                                    if (form) {
                                        const input = form.querySelector(`[name="${key}"]`);
                                        if (input) {
                                            input.value = value;
                                        }
                                    }
                                }
                            });
                        });
                    } else {
                        console.error("Fehler beim Laden der Einstellungen:", response.statusText);
                    }
                } catch (error) {
                    console.error("Fehler beim Laden der Einstellungen:", error);
                }
            }
            document.getElementById("saveSettings").addEventListener("click", saveSettings);
            // Einstellungen speichern
            async function saveSettings() {
                const settings = {};

                // Map keys to sections
                const keyToSection = {
                    // Directories
                    "classes_directory": "Directories",
                    "teachers_directory": "Directories",
                    "log_directory": "Directories",
                    "xlsx_directory": "Directories",
                    "import_directory": "Directories",
                    "schildexport_directory": "Directories",
                    "class_size_directory": "Directories",
                    "attest_file_directory": "Directories",
                    "nachteilsausgleich_file_directory": "Directories",
                    // ProcessingOptions
                    "use_abschlussdatum": "ProcessingOptions",
                    "create_second_file": "ProcessingOptions",
                    "warn_entlassdatum": "ProcessingOptions",
                    "warn_aufnahmedatum": "ProcessingOptions",
                    "warn_klassenwechsel": "ProcessingOptions",
                    "warn_new_students": "ProcessingOptions",
                    "create_class_size_file": "ProcessingOptions",
                    "timeframe_hours": "ProcessingOptions",
                    "enable_attestpflicht_column": "ProcessingOptions",
                    "enable_nachteilsausgleich_column": "ProcessingOptions",
                    // Email settings
                    "smtp_server": "Email",
                    "smtp_port": "Email",
                    "smtp_user": "Email",
                    "smtp_password": "Email",
                    "smtp_encryption": "Email",
                    // OAuth
                    "use_oauth": "OAuth",
                    "credentials_path": "OAuth",
                    // Admin
                    "admin_email": "Email", // Since admin_email is under [Email] section
                };

                // Collect data from all forms
                tabs.forEach((tab) => {
                    const form = document.getElementById(tab.form);
                    if (form) {
                        const formData = new FormData(form);
                        formData.forEach((value, key) => {
                            const section = keyToSection[key];
                            if (section) {
                                if (!settings[section]) settings[section] = {};
                                settings[section][key] = value;
                            }
                        });
                    }
                });

                try {
                    // Send settings to server
                    const response = await fetch("/save-settings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ settings }),
                    });
                    if (!response.ok) {
                        console.error("Fehler beim Speichern der Einstellungen:", response.statusText);
                        alert("Fehler beim Speichern der Einstellungen.");
                    } else {
                        alert("Einstellungen erfolgreich gespeichert!");
                    }
                } catch (error) {
                    console.error("Fehler beim Speichern der Einstellungen:", error);
                    alert("Fehler beim Speichern der Einstellungen.");
                }
            }
            // Load settings when the page loads
            loadSettings();
        });


        const labels = {
            use_abschlussdatum: "...falls dieses fr√ºher liegt oder kein Entlassdatum existiert",
            enable_attestpflicht_column: "Analysiert Daten aus dem Attestpflicht-Datei-Verzeichnis f√ºr eine zus√§tzliche Ja/Nein Spalte",
            enable_nachteilsausgleich_column: "Analysiert Daten aus dem Nachteilsausgleich-Datei-Verzeichnis f√ºr eine zus√§tzliche Ja/Nein Spalte",
            create_second_file: "Abg√§nger und Abschl√ºsse ohne...",
            create_class_size_file: "N√ºtzlich f√ºr Stundenplaner und das Vertretungsteam",
            warn_entlassdatum: "Von der (Stand jetzt) Vergangneheit auf dem Zeitstrahl nach rechts (generiert Dokumentationsl√ºcke)",
            warn_aufnahmedatum: "z.B. von einer weniger weiten Vergangenheit in eine weite(re) Vergangenheit (generiert Dokumentationsl√ºcke)",
            warn_klassenwechsel: "z.B. zur Information wegen Sch√ºlergruppenzuweisung oder auch Nachdokumentation/Korrektur des Wechseldatums",
            warn_new_students: "z.B.: zur Information wegen Sch√ºlergruppenzuweisung",
            timeframe_hours: "Zeitfenster in Stunden f√ºr die Vergleiche.",
            import_directory: "Verzeichnis, in dem die Import-Dateien f√ºr WebUntis gespeichert werden.",
            schildexport_directory: "Verzeichnis, aus dem die Schild-Exporte abgerufen werden.",
            classes_directory: "Verzeichnis f√ºr die Klassendaten. Sie werden f√ºr die Klassenlehrkraft-Zuordnung f√ºr die Warnungs-Funktion ben√∂tigt.",
            teachers_directory: "Verzeichnis f√ºr die Lehrerdaten. Sie werden f√ºr die Namensermittlung und Email-Adressen-Ermittlung f√ºr die Warnungs-Funktion ben√∂tigt.",
            log_directory: "Verzeichnis f√ºr die Log-Dateien. Darunter √Ñnderungs-Logs zwischen der neuesten und vorherigen Import-Datei, aber auch Logs f√ºr den Logs-Versand an die Admin-Email Adresse.",
            xlsx_directory: "Verzeichnis f√ºr die Excel-Dateien. Dies sind ebenfalls Log-Datein aber als ganze Tabelle mit markierten √Ñnderungen.",
            class_size_directory: "Verzeichnis f√ºr eine separat generierte Klassengr√∂√üendatei zur Verwendung durch Stundenplaner und Vertretungsteam",
            attest_file_directory: "Verzeichnis f√ºr eine ImportDatei, die nur die Sch√ºler mit Attestpflicht enth√§lt zur Verwendung Attestpflicht-Spalte",
            nachteilsausgleich_file_directory: "Verzeichnis f√ºr eine ImportDatei, die nur die Sch√ºler mit Nachteilsausgleich enth√§lt zur Verwendung Nachteilsausgleich-Spalte",
            smtp_server: "SMTP-Server-Adresse f√ºr den E-Mail-Versand.",
            smtp_port: "Port des SMTP-Servers (z. B. 587 f√ºr STARTTLS).",
            smtp_user: "Benutzername f√ºr den SMTP-Server.",
            smtp_password: "Passwort f√ºr den SMTP-Server.",
            admin_email: "E-Mail-Adresse des Administrators f√ºr Benachrichtigungen. Darunter Admin-Warnungen bei im Vergleich zum Schild-Export fehlenden Klassen- und Lehrkraftdaten, aber auch zum Versand von Log-Emails und -Datein."
        };

        function getLabel(key) {
            return labels[key] || key; // Fallback auf den Key, falls kein Label existiert
        }

        document.querySelectorAll("label").forEach(label => {
            const key = label.getAttribute("for");
            if (key && labels[key]) {
                label.innerHTML += `<small class="text-muted"> (${getLabel(key)})</small>`;
            }
        });
    </script>

    {% if not no_directory_change %}
    <script>
        document.querySelectorAll("button[data-directory-input]").forEach((button) => {
            button.addEventListener("click", function () {
                const inputId = this.getAttribute("data-directory-input");
                if (inputId) {
                    // Aufruf der neuen Route zum √ñffnen der Dateiauswahl
                    fetch('/select-directory', {
                        method: 'POST'
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.selected_directory) {
                                document.getElementById(inputId).value = data.selected_directory;
                            } else {
                                alert("Keine Auswahl getroffen.");
                            }
                        })
                        .catch(error => {
                            console.error("Fehler beim Ausw√§hlen des Verzeichnisses:", error);
                            alert("Fehler beim Ausw√§hlen des Verzeichnisses.");
                        });
                }
            });
        });
    </script>
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const uploadArea = document.getElementById("uploadArea");
            const toggleUploadButton = document.getElementById("toggleUploadArea");

            if (toggleUploadButton) {
                toggleUploadButton.addEventListener("click", function () {
                    uploadArea.style.display = uploadArea.style.display === "none" || uploadArea.style.display === "" ? "block" : "none";
                });
            }

            // Handle the form submission
            const uploadForm = document.getElementById("uploadForm");
            if (uploadForm) {
                uploadForm.addEventListener("submit", function (event) {
                    event.preventDefault();
                    const formData = new FormData();

                    // Append class data files
                    const classDataFiles = document.getElementById("classDataFiles").files;
                    for (let i = 0; i < classDataFiles.length; i++) {
                        formData.append("class_data_files", classDataFiles[i]);
                    }

                    // Append teacher data files
                    const teacherDataFiles = document.getElementById("teacherDataFiles").files;
                    for (let i = 0; i < teacherDataFiles.length; i++) {
                        formData.append("teacher_data_files", teacherDataFiles[i]);
                    }

                    // Append Schild-Export files
                    const schildExportFiles = document.getElementById("schildExportFiles").files;
                    for (let i = 0; i < schildExportFiles.length; i++) {
                        formData.append("schild_export_files", schildExportFiles[i]);
                    }

                    fetch('/upload-files', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                        })
                        .catch(error => {
                            console.error("Fehler beim Hochladen der Dateien:", error);
                            alert("Fehler beim Hochladen der Dateien.");
                        });
                });
            }
        });
    </script>


    <script>
        document.getElementById("generateEmails")?.addEventListener("click", function () {
            fetch("/generate_emails", {
                method: "POST"
            }).then(response => response.json()).then(data => {
                alert(data.message);
                if (data.emails) {
                    window.location.href = "/view_generated_emails";
                }
            });
        });

        document.getElementById("sendEmails")?.addEventListener("click", function () {
            fetch("/send_emails", {
                method: "POST"
            }).then(response => response.json()).then(data => {
                alert(data.message);
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const toggleButton = document.getElementById("toggleShortcutCreator");
            const shortcutCreator = document.getElementById("shortcutCreator");
            const exePathInput = document.getElementById("exePath");
            const argsInput = document.getElementById("args");
            const availableArgs = document.getElementById("availableArgs");
            const argDescription = document.getElementById("argDescription");
            const browseButton = document.getElementById("browseExePath");
            const hiddenFileInput = document.createElement("input");
            const validationMessage = document.getElementById("fileValidationMessage");
            let argumentCache = [];

            // Fetch the executable path from the server
            fetch('/get-executable-path')
                .then(response => response.json())
                .then(data => {
                    if (data.exePath) {
                        exePathInput.value = data.exePath;
                        validationMessage.textContent = "Ausf√ºhrungspfad geladen.";
                        validationMessage.classList.remove("text-danger");
                        validationMessage.classList.add("text-success");
                    } else {
                        validationMessage.textContent = "Ausf√ºhrungspfad konnte nicht ermittelt werden.";
                        validationMessage.classList.add("text-danger");
                    }
                })
                .catch(error => {
                    console.error("Fehler beim Laden des Ausf√ºhrungspfads:", error);
                    validationMessage.textContent = "Fehler beim Laden des Ausf√ºhrungspfads.";
                    validationMessage.classList.add("text-danger");
                });

            // Fetch available arguments and descriptions from the backend
            fetch("/get-arguments")
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        argumentCache = data.arguments; // Cache arguments for later use
                        data.arguments.forEach((arg) => {
                            const option = document.createElement("option");
                            option.value = arg.name;
                            option.textContent = `${arg.name}`;
                            availableArgs.appendChild(option);
                        });

                        // Set initial description
                        argDescription.textContent =
                            data.arguments[0]?.description || "Select an argument to see its description.";
                    } else {
                        console.error("Failed to fetch arguments:", data.error);
                    }
                });

            // Update the argument description on selection
            availableArgs.addEventListener("change", function () {
                const selectedArg = availableArgs.value;
                const argDetails = argumentCache.find((arg) => arg.name === selectedArg);
                argDescription.textContent = argDetails?.description || "Description not available.";
            });

            // Add selected argument to the args input field
            document.getElementById("addArg").addEventListener("click", function () {
                const selectedArg = availableArgs.value;
                if (selectedArg) {
                    argsInput.value = argsInput.value ? `${argsInput.value} ${selectedArg}` : selectedArg;
                }
            });

            // Generate the command
            document.getElementById("generateCommand").addEventListener("click", function () {
                const command = `"${exePathInput.value}" ${argsInput.value}`;
                document.getElementById("outputCommand").value = command;
            });

            // Create the shortcut
            document.getElementById("createShortcut").addEventListener("click", function () {
                const exePathValue = exePathInput.value;
                const argsValue = argsInput.value;

                if (exePathValue) {
                    fetch("/create-shortcut", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ exePath: exePathValue, args: argsValue }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                alert("Shortcut created successfully!");
                            } else {
                                alert("Error creating shortcut: " + data.error);
                            }
                        });
                } else {
                    alert("Please provide the path to the executable file.");
                }
            });
        });

    </script>







</body>
</html>
